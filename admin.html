<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Firebase</title>
    <link rel="stylesheet" href="admin-style.css" />

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        update,
        remove,
        push,
        query,
        orderByChild,
        equalTo,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyASMM00t5QjjTiIUtvTEsN62VUR9TQAW5E",
        authDomain: "sadam-f9276.firebaseapp.com",
        databaseURL: "https://sadam-f9276-default-rtdb.firebaseio.com",
        projectId: "sadam-f9276",
        storageBucket: "sadam-f9276.firebasestorage.app",
        messagingSenderId: "277794745714",
        appId: "1:277794745714:web:ed4df2dfc9287945a541eb",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      console.log("‚úÖ Firebase inicializado correctamente");

      // Exponer database y funciones globalmente
      window.firebaseDB = database;
      window.firebaseRef = ref;
      window.firebaseGet = get;
      window.firebaseSet = set;
      window.firebaseUpdate = update;
      window.firebaseRemove = remove;
      window.firebasePush = push;
      window.firebaseQuery = query;
      window.firebaseOrderByChild = orderByChild;
      window.firebaseEqualTo = equalTo;

      // Notificar que Firebase est√° listo
      window.firebaseReady = true;
      window.dispatchEvent(new Event("firebaseReady"));
    </script>
  </head>
  <body>
    <!-- Panel de Administraci√≥n -->
    <div id="adminPanel" class="admin-panel">
      <!-- Header -->
      <header class="admin-header">
        <div class="admin-header-left">
          <img src="logo2.jpeg" alt="Logo" class="admin-logo" />
          <h1>Panel Admin</h1>
        </div>
        <div class="admin-header-right">
          <button
            onclick="toggleMenu()"
            class="btn-menu-toggle"
            title="Abrir men√∫"
          >
            ‚ò∞ Men√∫
          </button>
          <div class="button-grid" id="buttonGrid" style="display: none">
            <button
              onclick="window.location.href='index.html'"
              class="btn-secondary"
              title="Ir a p√°gina principal"
            >
              üè† Inicio
            </button>
            <button onclick="descargarBackup()" class="btn-secondary">
              üíæ Descargar Backup
            </button>
            <button
              onclick="document.getElementById('fileInput').click()"
              class="btn-secondary"
            >
              üìÇ Cargar Backup
            </button>
            <button
              onclick="location.reload()"
              class="btn-secondary"
              title="Recargar datos desde Firebase"
            >
              üìã Ver Archivos Blob
            </button>
          </div>
          <input
            type="file"
            id="fileInput"
            accept=".json"
            style="display: none"
            onchange="cargarBackup(event)"
          />
        </div>
      </header>

      <!-- Contenido Principal -->
      <div class="admin-content">
        <!-- Barra de b√∫squeda y filtros -->
        <div class="admin-toolbar">
          <div class="search-box">
            <input
              type="text"
              id="searchBox"
              placeholder="üîç Buscar perfume o marca..."
              onkeyup="buscarPerfumes()"
            />
          </div>
          <div class="filter-box">
            <select id="categoriaFiltro" onchange="filtrarTabla()">
              <option value="">Todas las categor√≠as</option>
              <option value="arabes">√Årabes</option>
              <option value="disenador">Dise√±ador</option>
              <option value="nichos">Nichos</option>
              <option value="sets">Sets</option>
            </select>
            <button onclick="abrirModalAgregar()" class="btn-add">
              ‚ûï Agregar Perfume
            </button>
            <button onclick="cargarJSON()" class="btn-refresh">
              üîÑ Recargar
            </button>
          </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-number" id="totalPerfumes">0</div>
            <div class="stat-label">Total Perfumes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalArabes">0</div>
            <div class="stat-label">√Årabes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalDisenador">0</div>
            <div class="stat-label">Dise√±ador</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalNichos">0</div>
            <div class="stat-label">Nichos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalSets">0</div>
            <div class="stat-label">Sets</div>
          </div>
        </div>

        <!-- Tabla de perfumes -->
        <div class="table-container">
          <table id="perfumesTable">
            <thead>
              <tr>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Marca</th>
                <th>Categor√≠a</th>
                <th>ML</th>
                <th>Precio Final</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="perfumesTableBody">
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px">
                  Cargando perfumes...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal de Edici√≥n -->
    <div id="modal" class="modal">
      <div class="modal-overlay" onclick="cerrarModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Editar Perfume</h2>
          <button class="modal-close" onclick="cerrarModal()">√ó</button>
        </div>
        <form id="perfumeForm">
          <div class="modal-body">
            <div class="form-group">
              <label for="nombre">Nombre del Perfume *</label>
              <input type="text" id="nombre" required />
            </div>

            <div class="form-group">
              <label for="categoriaSelect">Categor√≠a *</label>
              <select
                id="categoriaSelect"
                required
                onchange="actualizarMarcas()"
              >
                <option value="">Seleccionar categor√≠a existente</option>
                <option value="arabes">√Årabes</option>
                <option value="disenador">Dise√±ador</option>
                <option value="nichos">Nichos</option>
                <option value="sets">Sets</option>
                <option value="__NUEVA__">‚ûï Agregar nueva categor√≠a</option>
              </select>
            </div>

            <div
              class="form-group"
              id="categoriaInputGroup"
              style="display: none"
            >
              <label for="categoriaInput">Nueva Categor√≠a *</label>
              <input
                type="text"
                id="categoriaInput"
                placeholder="Ej: premium, ofertas"
              />
              <small style="color: #666; font-size: 12px">
                Escribe el nombre de la nueva categor√≠a
              </small>
            </div>

            <div class="form-group">
              <label for="marcaSelect">Marca *</label>
              <select id="marcaSelect" required onchange="toggleMarcaInput()">
                <option value="">Seleccionar marca existente</option>
                <option value="__NUEVA__">‚ûï Agregar nueva marca</option>
              </select>
            </div>

            <div class="form-group" id="marcaInputGroup" style="display: none">
              <label for="marcaInput">Nueva Marca *</label>
              <input
                type="text"
                id="marcaInput"
                placeholder="Ej: Dior, Chanel, Afnan"
              />
              <small style="color: #666; font-size: 12px">
                Escribe el nombre de la nueva marca
              </small>
            </div>

            <div class="form-group">
              <label for="imagen">URL de la Imagen *</label>
              <input
                type="url"
                id="imagen"
                required
                placeholder="https://ejemplo.com/imagen.jpg"
              />
              <small style="color: #666; font-size: 12px">
                Puedes cambiar la imagen del perfume aqu√≠
              </small>
            </div>

            <div class="form-group">
              <label for="precio">Precio Final *</label>
              <input
                type="number"
                id="precio"
                required
                placeholder="Ej: 3500"
              />
              <small style="color: #666; font-size: 12px"
                >Este es el precio con incremento incluido</small
              >
            </div>

            <div class="form-group">
              <label>
                <input
                  type="checkbox"
                  id="preciosPersonalizadosCheck"
                  onchange="togglePreciosPersonalizados()"
                />
                Precios por tama√±o
              </label>
              <small style="color: #666; font-size: 12px; display: block">
                Activa esto si el perfume tiene diferentes precios seg√∫n el
                tama√±o
              </small>
            </div>

            <div
              class="form-group"
              id="preciosPersonalizadosSection"
              style="display: none"
            >
              <label>Precios por Tama√±o</label>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(2, 1fr);
                  gap: 10px;
                  margin-top: 10px;
                "
              >
                <div>
                  <label style="font-size: 12px">30ml</label>
                  <input
                    type="number"
                    id="precio_30"
                    placeholder="Precio 30ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">50ml</label>
                  <input
                    type="number"
                    id="precio_50"
                    placeholder="Precio 50ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">60ml</label>
                  <input
                    type="number"
                    id="precio_60"
                    placeholder="Precio 60ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">75ml</label>
                  <input
                    type="number"
                    id="precio_75"
                    placeholder="Precio 75ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">80ml</label>
                  <input
                    type="number"
                    id="precio_80"
                    placeholder="Precio 80ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">90ml</label>
                  <input
                    type="number"
                    id="precio_90"
                    placeholder="Precio 90ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">100ml</label>
                  <input
                    type="number"
                    id="precio_100"
                    placeholder="Precio 100ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">120ml</label>
                  <input
                    type="number"
                    id="precio_120"
                    placeholder="Precio 120ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">125ml</label>
                  <input
                    type="number"
                    id="precio_125"
                    placeholder="Precio 125ml"
                  />
                </div>
                <div>
                  <label style="font-size: 12px">200ml</label>
                  <input
                    type="number"
                    id="precio_200"
                    placeholder="Precio 200ml"
                  />
                </div>
              </div>
              <small
                style="
                  color: #666;
                  font-size: 12px;
                  margin-top: 10px;
                  display: block;
                "
              >
                Deja en blanco los tama√±os que no apliquen
              </small>
            </div>

            <div class="form-group">
              <label for="genero">G√©nero</label>
              <select id="genero">
                <option value="unisex">Unisex</option>
                <option value="hombre">Hombre</option>
                <option value="mujer">Mujer</option>
              </select>
            </div>

            <div class="form-group">
              <label for="notaSalida">Nota de Salida</label>
              <input
                type="text"
                id="notaSalida"
                placeholder="Ej: üçã Lim√≥n, üçä Naranja, üåø Bergamota"
              />
              <small style="color: #666; font-size: 12px">
                Puedes usar emojis para las notas
              </small>
            </div>

            <div class="form-group">
              <label for="notaCorazon">Nota de Coraz√≥n</label>
              <input
                type="text"
                id="notaCorazon"
                placeholder="Ej: üåπ Rosa, üå∏ Jazm√≠n, üå∫ Lirio"
              />
            </div>

            <div class="form-group">
              <label for="notaFondo">Nota de Fondo</label>
              <input
                type="text"
                id="notaFondo"
                placeholder="Ej: ü™µ Madera, üí® Almizcle, üç¶ Vainilla"
              />
            </div>

            <div class="form-group">
              <label for="descripcion">Descripci√≥n</label>
              <textarea
                id="descripcion"
                rows="3"
                placeholder="Descripci√≥n del perfume..."
              ></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn-primary">üíæ Guardar</button>
            <button type="button" onclick="cerrarModal()" class="btn-secondary">
              ‚ùå Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Gesti√≥n de Marcas/Categor√≠as -->
    <div id="gestionModal" class="modal">
      <div class="modal-overlay" onclick="cerrarGestionModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>‚öôÔ∏è Gestionar Marcas y Categor√≠as</h2>
          <button class="modal-close" onclick="cerrarGestionModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="tabs-container">
            <button class="tab-btn active" onclick="mostrarTab('categorias')">
              Categor√≠as
            </button>
            <button class="tab-btn" onclick="mostrarTab('marcas')">
              Marcas
            </button>
          </div>

          <!-- Tab Categor√≠as -->
          <div id="tabCategorias" class="tab-content active">
            <h3>Categor√≠as Existentes</h3>
            <div id="listaCategorias" class="lista-items"></div>
          </div>

          <!-- Tab Marcas -->
          <div id="tabMarcas" class="tab-content">
            <div class="form-group">
              <label>Selecciona una categor√≠a:</label>
              <select
                id="categoriaParaMarcas"
                onchange="cargarMarcasDeCategoria()"
              >
                <option value="">Seleccionar categor√≠a...</option>
              </select>
            </div>
            <h3>Marcas de la categor√≠a</h3>
            <div id="listaMarcas" class="lista-items"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="cerrarGestionModal()" class="btn-secondary">
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <script>
      let perfumesData = {};
      let todosLosPerfumes = [];
      let perfumesFiltrados = [];
      let modoEdicion = false;
      let perfumeEditando = null;

      // Cargar JSON desde Firebase SOLAMENTE
      async function cargarJSON(mostrarDespues = true) {
        try {
          console.log("üîÑ [FIREBASE] Cargando datos...");

          const dbRef = window.firebaseRef(window.firebaseDB, "perfumes");
          const snapshot = await window.firebaseGet(dbRef);

          if (!snapshot.exists()) {
            throw new Error(
              "No hay datos en Firebase. Carga un backup primero usando upload-to-firebase.html"
            );
          }

          perfumesData = snapshot.val();
          console.log("‚úÖ [FIREBASE] Datos cargados exitosamente");
          console.log(
            "üìä [FIREBASE] Claves encontradas:",
            Object.keys(perfumesData).length
          );

          procesarDatos();
          actualizarEstadisticas();

          if (mostrarDespues) {
            mostrarPerfumes();
          }
        } catch (error) {
          console.error("‚ùå Error al cargar datos:", error);
          alert("‚ùå Error al cargar datos: " + error.message);
        }
      }

      // Procesar datos de Firebase (formato: objeto con IDs √∫nicos)
      function procesarDatos() {
        todosLosPerfumes = [];

        // Firebase format: { "arabes_Dumont_0": {...}, "disenador_Chanel_0": {...} }
        Object.keys(perfumesData).forEach((firebaseId) => {
          const perfume = perfumesData[firebaseId];
          if (perfume && typeof perfume === "object") {
            todosLosPerfumes.push({
              ...perfume,
              firebaseId, // Guardar el ID de Firebase para editar/eliminar
            });
          }
        });

        perfumesFiltrados = [...todosLosPerfumes];
        console.log("üì¶ Total perfumes procesados:", todosLosPerfumes.length);
      }

      // Actualizar estad√≠sticas
      function actualizarEstadisticas() {
        document.getElementById("totalPerfumes").textContent =
          todosLosPerfumes.length;
        document.getElementById("totalArabes").textContent =
          todosLosPerfumes.filter((p) => p.categoria === "arabes").length;
        document.getElementById("totalDisenador").textContent =
          todosLosPerfumes.filter((p) => p.categoria === "disenador").length;
        document.getElementById("totalNichos").textContent =
          todosLosPerfumes.filter(
            (p) => p.categoria === "nichos" || p.categoria === "nicho"
          ).length;
        document.getElementById("totalSets").textContent =
          todosLosPerfumes.filter((p) => p.categoria === "sets").length;
      }

      // Mostrar perfumes en tabla
      function mostrarPerfumes() {
        const tbody = document.getElementById("perfumesTableBody");
        tbody.innerHTML = "";

        perfumesFiltrados.forEach((perfume) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td><img src="${perfume.imagen}" alt="${
            perfume.nombre
          }" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
                    <td>${perfume.nombre}</td>
                    <td>${perfume.marca}</td>
                    <td><span class="badge badge-${perfume.categoria}">${
            perfume.categoria
          }</span></td>
                    <td>${perfume.ml ? perfume.ml + " ml" : "-"}</td>
                    <td>RD$ ${perfume.precio}</td>
                    <td>
                        <button class="btn-edit" data-firebase-id="${
                          perfume.firebaseId
                        }">‚úèÔ∏è</button>
                        <button class="btn-delete" data-firebase-id="${
                          perfume.firebaseId
                        }" data-nombre="${perfume.nombre}">üóëÔ∏è</button>
                    </td>
                `;
          tbody.appendChild(tr);
        });

        // Agregar event listeners a los botones
        tbody.querySelectorAll(".btn-edit").forEach((btn) => {
          btn.addEventListener("click", function () {
            editarPerfume(this.dataset.firebaseId);
          });
        });

        tbody.querySelectorAll(".btn-delete").forEach((btn) => {
          btn.addEventListener("click", function () {
            eliminarPerfume(this.dataset.firebaseId, this.dataset.nombre);
          });
        });
      }

      // Buscar
      function buscarPerfumes() {
        const termino = document
          .getElementById("searchBox")
          .value.toLowerCase();
        perfumesFiltrados = todosLosPerfumes.filter(
          (p) =>
            p.nombre.toLowerCase().includes(termino) ||
            p.marca.toLowerCase().includes(termino)
        );
        filtrarTabla();
      }

      // Filtrar por categor√≠a
      function filtrarTabla() {
        const categoria = document.getElementById("categoriaFiltro").value;
        const termino = document
          .getElementById("searchBox")
          .value.toLowerCase();

        perfumesFiltrados = todosLosPerfumes.filter((p) => {
          const matchCategoria = !categoria || p.categoria === categoria;
          const matchBusqueda =
            !termino ||
            p.nombre.toLowerCase().includes(termino) ||
            p.marca.toLowerCase().includes(termino);
          return matchCategoria && matchBusqueda;
        });

        mostrarPerfumes();
      }

      // Actualizar lista de marcas seg√∫n categor√≠a
      function actualizarMarcas() {
        const categoriaSelect = document.getElementById("categoriaSelect");
        const marcaSelect = document.getElementById("marcaSelect");
        const categoriaInputGroup = document.getElementById(
          "categoriaInputGroup"
        );

        // Mostrar/ocultar input de nueva categor√≠a
        if (categoriaSelect.value === "__NUEVA__") {
          categoriaInputGroup.style.display = "block";
          marcaSelect.innerHTML =
            '<option value="">Primero crea la categor√≠a</option>';
          marcaSelect.disabled = true;
          return;
        } else {
          categoriaInputGroup.style.display = "none";
          marcaSelect.disabled = false;
        }

        // Cargar marcas de la categor√≠a seleccionada
        marcaSelect.innerHTML =
          '<option value="">Seleccionar marca existente</option>';

        const categoria = categoriaSelect.value;
        if (categoria) {
          // Obtener marcas √∫nicas de la categor√≠a seleccionada
          const marcasSet = new Set();

          // Formato Firebase: objeto con IDs √∫nicos
          Object.keys(perfumesData).forEach((firebaseId) => {
            const p = perfumesData[firebaseId];
            if (p.categoria === categoria && p.marca) {
              marcasSet.add(p.marca);
            }
          });

          const marcas = Array.from(marcasSet).sort();
          marcas.forEach((marca) => {
            const option = document.createElement("option");
            option.value = marca;
            option.textContent = marca;
            marcaSelect.appendChild(option);
          });
        }

        marcaSelect.innerHTML +=
          '<option value="__NUEVA__">‚ûï Agregar nueva marca</option>';
      }

      function toggleMarcaInput() {
        const marcaSelect = document.getElementById("marcaSelect");
        const marcaInputGroup = document.getElementById("marcaInputGroup");

        if (marcaSelect.value === "__NUEVA__") {
          marcaInputGroup.style.display = "block";
        } else {
          marcaInputGroup.style.display = "none";
        }
      }

      function togglePreciosPersonalizados() {
        const checkbox = document.getElementById("preciosPersonalizadosCheck");
        const section = document.getElementById("preciosPersonalizadosSection");
        const precioField = document.getElementById("precio");

        if (checkbox.checked) {
          section.style.display = "block";
          precioField.required = false;
          precioField.parentElement.style.opacity = "0.5";
        } else {
          section.style.display = "none";
          precioField.required = true;
          precioField.parentElement.style.opacity = "1";
        }
      }

      // Modal
      function abrirModalAgregar() {
        modoEdicion = false;
        perfumeEditando = null;
        document.getElementById("modalTitle").textContent = "Agregar Perfume";
        document.getElementById("perfumeForm").reset();
        document.getElementById("categoriaInputGroup").style.display = "none";
        document.getElementById("marcaInputGroup").style.display = "none";
        document.getElementById("preciosPersonalizadosCheck").checked = false;
        togglePreciosPersonalizados();
        actualizarMarcas();
        document.getElementById("modal").style.display = "block";
      }

      function editarPerfume(firebaseId) {
        console.log("üîç Editando perfume con ID:", firebaseId);

        modoEdicion = true;
        perfumeEditando = firebaseId;

        const perfume = perfumesData[firebaseId];

        if (!perfume) {
          console.error("‚ùå No se encontr√≥ el perfume");
          alert("‚ùå No se pudo encontrar el perfume para editar");
          return;
        }

        console.log("‚úÖ Perfume encontrado:", perfume.nombre);

        document.getElementById("modalTitle").textContent = "Editar Perfume";
        document.getElementById("nombre").value = perfume.nombre || "";
        document.getElementById("categoriaSelect").value = perfume.categoria;
        actualizarMarcas();
        document.getElementById("marcaSelect").value = perfume.marca;
        document.getElementById("precio").value = perfume.precio || "";
        document.getElementById("genero").value = perfume.genero || "unisex";
        document.getElementById("imagen").value = perfume.imagen || "";
        document.getElementById("descripcion").value =
          perfume.descripcion || "";

        // Cargar notas si existen
        document.getElementById("notaSalida").value =
          perfume.notas?.salida || "";
        document.getElementById("notaCorazon").value =
          perfume.notas?.corazon || "";
        document.getElementById("notaFondo").value = perfume.notas?.fondo || "";

        // Cargar precios personalizados si existen
        const checkbox = document.getElementById("preciosPersonalizadosCheck");
        if (perfume.preciosPersonalizados) {
          checkbox.checked = true;
          togglePreciosPersonalizados();
          Object.keys(perfume.preciosPersonalizados).forEach((tamano) => {
            const input = document.getElementById(`precio_${tamano}`);
            if (input) {
              input.value = perfume.preciosPersonalizados[tamano];
            }
          });
        } else {
          checkbox.checked = false;
          togglePreciosPersonalizados();
        }

        document.getElementById("modal").style.display = "block";
      }

      function cerrarModal() {
        document.getElementById("modal").style.display = "none";
        perfumeEditando = null;
        modoEdicion = false;
      }

      // Guardar perfume (agregar o editar) - DIRECTO A FIREBASE
      document
        .getElementById("perfumeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          try {
            console.log("üîµ GUARDANDO EN FIREBASE...");
            console.log("üîµ Modo edici√≥n:", modoEdicion);

            const usaPreciosPersonalizados = document.getElementById(
              "preciosPersonalizadosCheck"
            ).checked;

            // Construir precios personalizados si est√° activado
            let preciosPersonalizados = null;
            let tamanosDisponibles = [100];

            if (usaPreciosPersonalizados) {
              preciosPersonalizados = {};
              tamanosDisponibles = [];
              const tamanos = [30, 50, 60, 75, 80, 90, 100, 120, 125, 200];

              tamanos.forEach((tamano) => {
                const input = document.getElementById(`precio_${tamano}`);
                if (input && input.value) {
                  preciosPersonalizados[tamano] = parseInt(input.value);
                  tamanosDisponibles.push(tamano);
                }
              });

              if (tamanosDisponibles.length === 0) {
                alert("‚ö†Ô∏è Debes agregar al menos un precio para un tama√±o");
                return;
              }
            }

            // Calcular el precio a mostrar
            let precioFinal;
            if (usaPreciosPersonalizados) {
              const precios = Object.values(preciosPersonalizados);
              precioFinal = Math.min(...precios);
            } else {
              precioFinal = parseInt(document.getElementById("precio").value);
            }

            const mlValue =
              tamanosDisponibles.length > 0 ? tamanosDisponibles[0] : null;

            // Obtener categor√≠a
            let categoria = document.getElementById("categoriaSelect").value;
            if (categoria === "__NUEVA__") {
              categoria = document
                .getElementById("categoriaInput")
                .value.trim()
                .toLowerCase();
              if (!categoria) {
                alert("‚ö†Ô∏è Debes escribir el nombre de la nueva categor√≠a");
                return;
              }
            }

            // Obtener marca
            let marca = document.getElementById("marcaSelect").value;
            if (marca === "__NUEVA__") {
              marca = document.getElementById("marcaInput").value.trim();
              if (!marca) {
                alert("‚ö†Ô∏è Debes escribir el nombre de la nueva marca");
                return;
              }
            }

            const perfume = {
              nombre: document.getElementById("nombre").value,
              imagen: document.getElementById("imagen").value,
              precio: precioFinal,
              genero: document.getElementById("genero").value,
              descripcion: document.getElementById("descripcion").value || "",
              ml: mlValue,
              categoria,
              marca,
              notas: {
                salida: document.getElementById("notaSalida").value || "",
                corazon: document.getElementById("notaCorazon").value || "",
                fondo: document.getElementById("notaFondo").value || "",
              },
              tamanosDisponibles,
              preciosPersonalizados,
            };

            let firebaseId;

            if (modoEdicion && perfumeEditando) {
              // EDITAR: Usar el firebaseId existente
              firebaseId = perfumeEditando;
              perfume.id = firebaseId;
              console.log("‚úèÔ∏è Editando perfume ID:", firebaseId);
            } else {
              // AGREGAR: Crear nuevo ID
              // Contar perfumes existentes con misma categoria/marca para el √≠ndice
              const perfumesExistentes = Object.values(perfumesData).filter(
                (p) => p.categoria === categoria && p.marca === marca
              );
              const index = perfumesExistentes.length;

              firebaseId = `${categoria}_${marca}_${index}`.replace(
                /[.#$[\]\/\s]/g,
                "_"
              );
              perfume.id = firebaseId;
              console.log("‚ûï Creando perfume ID:", firebaseId);
            }

            // Guardar en Firebase
            const dbRef = window.firebaseRef(
              window.firebaseDB,
              `perfumes/${firebaseId}`
            );
            await window.firebaseSet(dbRef, perfume);

            console.log("‚úÖ Perfume guardado en Firebase");

            // Actualizar datos locales
            perfumesData[firebaseId] = perfume;

            cerrarModal();
            procesarDatos();
            actualizarEstadisticas();
            filtrarTabla(); // Mantener filtro activo

            alert(
              modoEdicion
                ? "‚úÖ Perfume editado exitosamente"
                : "‚úÖ Perfume agregado exitosamente"
            );
          } catch (error) {
            console.error("‚ùå Error al guardar:", error);
            alert("‚ùå Error al guardar: " + error.message);
          }
        });

      // Eliminar perfume - DIRECTO A FIREBASE
      async function eliminarPerfume(firebaseId, nombre) {
        if (!confirm(`¬øEliminar "${nombre}"?`)) return;

        try {
          console.log("üóëÔ∏è Eliminando perfume ID:", firebaseId);

          // Eliminar de Firebase
          const dbRef = window.firebaseRef(
            window.firebaseDB,
            `perfumes/${firebaseId}`
          );
          await window.firebaseRemove(dbRef);

          console.log("‚úÖ Perfume eliminado de Firebase");

          // Actualizar datos locales
          delete perfumesData[firebaseId];

          // Reprocesar y actualizar
          procesarDatos();
          actualizarEstadisticas();
          filtrarTabla(); // Mantener filtro activo

          alert("‚úÖ Perfume eliminado correctamente!");
        } catch (error) {
          console.error("‚ùå Error al eliminar:", error);
          alert("‚ùå Error al eliminar: " + error.message);
        }
      }

      // Descargar backup desde Firebase
      function descargarBackup() {
        // Formato Firebase: objeto con IDs √∫nicos
        const backup = { perfumes: perfumesData };
        const dataStr = JSON.stringify(backup, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `perfumes-firebase-backup-${
          new Date().toISOString().split("T")[0]
        }.json`;
        a.click();
        console.log(
          "üíæ Backup descargado:",
          Object.keys(perfumesData).length,
          "perfumes"
        );
      }

      // Cargar backup y subir a Firebase
      async function cargarBackup(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (
          !confirm(
            `‚ö†Ô∏è ¬øCargar backup desde "${file.name}"?\n\nEsto REEMPLAZAR√Å TODOS los datos en Firebase.`
          )
        ) {
          event.target.value = "";
          return;
        }

        try {
          const text = await file.text();
          const data = JSON.parse(text);

          console.log("üìÑ Archivo cargado:", data);

          if (!data.perfumes) {
            throw new Error("El archivo no contiene la propiedad 'perfumes'");
          }

          let perfumesObj = {};

          // Detectar formato
          if (
            typeof data.perfumes === "object" &&
            !Array.isArray(data.perfumes)
          ) {
            // Ya est√° en formato Firebase (objeto con IDs)
            perfumesObj = data.perfumes;
            console.log("‚úÖ Formato Firebase detectado");
          } else if (Array.isArray(data.perfumes)) {
            // Formato array: convertir a Firebase
            console.log("üîÑ Convirtiendo array a formato Firebase...");
            data.perfumes.forEach((perfume, index) => {
              const categoria = perfume.categoria || "sin_categoria";
              const marca = perfume.marca || "sin_marca";
              const id = `${categoria}_${marca}_${index}`.replace(
                /[.#$[\]\/\\s]/g,
                "_"
              );
              perfumesObj[id] = { ...perfume, id };
            });
          } else {
            // Formato viejo anidado: convertir
            console.log("üîÑ Convirtiendo formato viejo...");
            Object.keys(data.perfumes).forEach((categoria) => {
              Object.keys(data.perfumes[categoria]).forEach((marca) => {
                const perfumes = data.perfumes[categoria][marca];
                perfumes.forEach((perfume, index) => {
                  const id = `${categoria}_${marca}_${index}`.replace(
                    /[.#$[\]\/\\s]/g,
                    "_"
                  );
                  perfumesObj[id] = { ...perfume, id, categoria, marca };
                });
              });
            });
          }

          const totalPerfumes = Object.keys(perfumesObj).length;
          if (totalPerfumes === 0) {
            throw new Error("El archivo no contiene perfumes v√°lidos");
          }

          console.log(`üì§ Subiendo ${totalPerfumes} perfumes a Firebase...`);

          // Subir a Firebase
          const dbRef = window.firebaseRef(window.firebaseDB, "perfumes");
          await window.firebaseSet(dbRef, perfumesObj);

          console.log("‚úÖ Datos subidos a Firebase");

          // Actualizar datos locales
          perfumesData = perfumesObj;
          procesarDatos();
          actualizarEstadisticas();
          mostrarPerfumes();

          alert(
            `‚úÖ Backup cargado exitosamente\n\n${totalPerfumes} perfumes subidos a Firebase`
          );
        } catch (error) {
          console.error("‚ùå Error al cargar backup:", error);
          alert(`‚ùå Error al cargar backup:\n${error.message}`);
        } finally {
          event.target.value = "";
        }
      }

      // ===== GESTI√ìN DE MARCAS Y CATEGOR√çAS =====

      function abrirGestionModal() {
        document.getElementById("gestionModal").style.display = "block";
        cargarCategorias();
        cargarCategoriasSelect();
      }

      function cerrarGestionModal() {
        document.getElementById("gestionModal").style.display = "none";
      }

      function mostrarTab(tab) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));

        if (tab === "categorias") {
          document.getElementById("tabCategorias").classList.add("active");
          document.querySelectorAll(".tab-btn")[0].classList.add("active");
          cargarCategorias();
        } else {
          document.getElementById("tabMarcas").classList.add("active");
          document.querySelectorAll(".tab-btn")[1].classList.add("active");
          cargarCategoriasSelect();
        }
      }

      function cargarCategorias() {
        const lista = document.getElementById("listaCategorias");
        lista.innerHTML = "";

        Object.keys(perfumesData.perfumes).forEach((categoria) => {
          const item = document.createElement("div");
          item.className = "item-gestion";
          item.innerHTML = `
            <span>${categoria}</span>
            <div>
              <button class="btn-edit" onclick="editarCategoria('${categoria}')">‚úèÔ∏è Editar</button>
              <button class="btn-delete" onclick="eliminarCategoria('${categoria}')">üóëÔ∏è Eliminar</button>
            </div>
          `;
          lista.appendChild(item);
        });
      }

      function cargarCategoriasSelect() {
        const select = document.getElementById("categoriaParaMarcas");
        select.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';

        Object.keys(perfumesData.perfumes).forEach((categoria) => {
          const option = document.createElement("option");
          option.value = categoria;
          option.textContent = categoria;
          select.appendChild(option);
        });
      }

      function cargarMarcasDeCategoria() {
        const categoria = document.getElementById("categoriaParaMarcas").value;
        const lista = document.getElementById("listaMarcas");
        lista.innerHTML = "";

        if (!categoria) return;

        const marcas = perfumesData.perfumes[categoria];
        Object.keys(marcas).forEach((marca) => {
          const item = document.createElement("div");
          item.className = "item-gestion";
          item.innerHTML = `
            <span>${marca}</span>
            <div>
              <button class="btn-edit" onclick="editarMarca('${categoria}', '${marca}')">‚úèÔ∏è Editar</button>
              <button class="btn-delete" onclick="eliminarMarca('${categoria}', '${marca}')">üóëÔ∏è Eliminar</button>
            </div>
          `;
          lista.appendChild(item);
        });
      }

      async function editarCategoria(categoriaVieja) {
        console.log("üéØ Iniciando edici√≥n de categor√≠a:", categoriaVieja);
        const nuevaCategoria = prompt(
          `Editar categor√≠a "${categoriaVieja}".\nNuevo nombre:`,
          categoriaVieja
        );
        if (!nuevaCategoria || nuevaCategoria === categoriaVieja) {
          console.log("‚ùå Edici√≥n cancelada");
          return;
        }

        console.log("‚úèÔ∏è Renombrando:", categoriaVieja, "‚Üí", nuevaCategoria);

        // Mover la categor√≠a
        perfumesData.perfumes[nuevaCategoria] =
          perfumesData.perfumes[categoriaVieja];
        delete perfumesData.perfumes[categoriaVieja];

        // IMPORTANTE: Actualizar la propiedad 'categoria' dentro de cada perfume
        Object.keys(perfumesData.perfumes[nuevaCategoria]).forEach((marca) => {
          Object.keys(perfumesData.perfumes[nuevaCategoria][marca]).forEach(
            (nombrePerfume) => {
              if (
                perfumesData.perfumes[nuevaCategoria][marca][nombrePerfume]
                  .categoria === categoriaVieja
              ) {
                perfumesData.perfumes[nuevaCategoria][marca][
                  nombrePerfume
                ].categoria = nuevaCategoria;
              }
            }
          );
        });

        console.log(
          "üìä Categor√≠as despu√©s de editar:",
          Object.keys(perfumesData.perfumes)
        );

        // Guardar estado actual de filtros
        const filtroActual = document.getElementById("categoriaFiltro").value;
        const busquedaActual = document.getElementById("searchBox").value;

        // Guardar primero
        console.log("üíæ Guardando cambios...");
        const guardado = await guardarEnLocalStorage();
        console.log("üíæ Resultado del guardado:", guardado);

        // Recargar desde la nube para tener los datos frescos
        console.log("üîÑ Recargando datos desde la nube...");
        await cargarJSON(false);

        // Restaurar filtros
        if (busquedaActual) {
          document.getElementById("searchBox").value = busquedaActual;
        }
        if (filtroActual) {
          document.getElementById("categoriaFiltro").value =
            filtroActual === categoriaVieja ? nuevaCategoria : filtroActual;
          filtrarTabla();
        } else {
          mostrarPerfumes();
        }

        console.log(
          "‚úÖ Datos recargados. Categor√≠as:",
          Object.keys(perfumesData.perfumes)
        );
      }

      async function eliminarCategoria(categoria) {
        if (
          !confirm(
            `¬øEliminar la categor√≠a "${categoria}" y TODOS sus perfumes?`
          )
        )
          return;

        // Guardar estado actual de filtros
        const filtroActual = document.getElementById("categoriaFiltro").value;
        const busquedaActual = document.getElementById("searchBox").value;

        delete perfumesData.perfumes[categoria];

        // Guardar primero
        await guardarEnLocalStorage();

        // Recargar desde la nube para tener los datos frescos
        await cargarJSON(false);

        // Restaurar filtros (limpiar si era la categor√≠a eliminada)
        if (busquedaActual) {
          document.getElementById("searchBox").value = busquedaActual;
        }
        if (filtroActual && filtroActual !== categoria) {
          document.getElementById("categoriaFiltro").value = filtroActual;
          filtrarTabla();
        } else {
          document.getElementById("categoriaFiltro").value = "";
          filtrarTabla();
        }
      }
      async function editarMarca(categoria, marcaVieja) {
        const nuevaMarca = prompt(
          `Editar marca "${marcaVieja}".\nNuevo nombre:`,
          marcaVieja
        );
        if (!nuevaMarca || nuevaMarca === marcaVieja) return;

        // Mover la marca
        perfumesData.perfumes[categoria][nuevaMarca] =
          perfumesData.perfumes[categoria][marcaVieja];
        delete perfumesData.perfumes[categoria][marcaVieja];

        // IMPORTANTE: Actualizar la propiedad 'marca' dentro de cada perfume
        Object.keys(perfumesData.perfumes[categoria][nuevaMarca]).forEach(
          (nombrePerfume) => {
            if (
              perfumesData.perfumes[categoria][nuevaMarca][nombrePerfume]
                .marca === marcaVieja
            ) {
              perfumesData.perfumes[categoria][nuevaMarca][
                nombrePerfume
              ].marca = nuevaMarca;
            }
          }
        );

        // Guardar estado actual de filtros
        const filtroActual = document.getElementById("categoriaFiltro").value;
        const busquedaActual = document.getElementById("searchBox").value;

        // Guardar primero
        await guardarEnLocalStorage();

        // Recargar desde la nube para tener los datos frescos
        await cargarJSON(false);

        // Restaurar filtros
        if (busquedaActual) {
          document.getElementById("searchBox").value = busquedaActual;
        }
        if (filtroActual) {
          document.getElementById("categoriaFiltro").value = filtroActual;
          filtrarTabla();
        } else {
          mostrarPerfumes();
        }
      }

      async function eliminarMarca(categoria, marca) {
        if (!confirm(`¬øEliminar la marca "${marca}" y TODOS sus perfumes?`))
          return;

        // Guardar estado actual de filtros
        const filtroActual = document.getElementById("categoriaFiltro").value;
        const busquedaActual = document.getElementById("searchBox").value;

        delete perfumesData.perfumes[categoria][marca];

        // Guardar primero
        await guardarEnLocalStorage();

        // Recargar desde la nube para tener los datos frescos
        await cargarJSON(false);

        // Restaurar filtros
        if (busquedaActual) {
          document.getElementById("searchBox").value = busquedaActual;
        }
        if (filtroActual) {
          document.getElementById("categoriaFiltro").value = filtroActual;
          filtrarTabla();
        } else {
          mostrarPerfumes();
        }
      }

      // Toggle men√∫ de botones
      function toggleMenu() {
        const buttonGrid = document.getElementById("buttonGrid");
        if (
          buttonGrid.style.display === "none" ||
          buttonGrid.style.display === ""
        ) {
          buttonGrid.style.display = "grid";
        } else {
          buttonGrid.style.display = "none";
        }
      }

      // Cerrar men√∫ al hacer clic fuera
      document.addEventListener("click", function (event) {
        const buttonGrid = document.getElementById("buttonGrid");
        const menuToggle = document.querySelector(".btn-menu-toggle");

        if (
          !buttonGrid.contains(event.target) &&
          !menuToggle.contains(event.target)
        ) {
          if (buttonGrid.style.display === "grid") {
            buttonGrid.style.display = "none";
          }
        }
      });

      // Cargar al inicio - esperar a que Firebase est√© listo
      if (window.firebaseReady) {
        cargarJSON();
      } else {
        window.addEventListener("firebaseReady", () => {
          cargarJSON();
        });
      }
    </script>
  </body>
</html>
